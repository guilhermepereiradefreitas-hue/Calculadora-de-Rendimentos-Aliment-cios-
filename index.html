<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Rendimento Aliment√≠cio</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    * {
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      max-width: 1400px;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      padding: 2.5rem;
      text-align: center;
      position: relative;
    }

    .logo-container {
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .logo-container img {
      max-width: 150px;
      max-height: 80px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.75rem;
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .header h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header p {
      margin: 0;
      font-size: 1.1rem;
      opacity: 0.95;
    }

    .content {
      padding: 2.5rem;
    }

    .form-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 2px solid #e9ecef;
    }

    .calculation-mode {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .mode-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid #667eea;
      background: #ffffff;
      color: #667eea;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mode-btn:hover {
      background: #f0f4ff;
    }

    .mode-btn.active {
      background: #667eea;
      color: #ffffff;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #2d3748;
      font-size: 0.95rem;
    }

    .form-group input {
      padding: 0.875rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #ffffff;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group input:disabled {
      background: #f1f5f9;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .info-badge {
      display: inline-block;
      background: #e0e7ff;
      color: #4338ca;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-delete {
      background: #ef4444;
      color: #ffffff;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-delete:hover {
      background: #dc2626;
    }

    .export-section {
      margin-bottom: 2rem;
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn-export {
      background: #10b981;
      color: #ffffff;
      padding: 0.875rem 1.75rem;
      font-size: 1rem;
    }

    .btn-export:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-export:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-readme {
      background: #8b5cf6;
      color: #ffffff;
      padding: 0.875rem 1.75rem;
      font-size: 1rem;
    }

    .btn-readme:hover {
      background: #7c3aed;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      background: #ffffff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
    }

    th {
      padding: 1.25rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 1.25rem;
      border-bottom: 1px solid #e9ecef;
      color: #2d3748;
      font-size: 0.95rem;
    }

    tbody tr {
      transition: background-color 0.2s ease;
    }

    tbody tr:hover {
      background-color: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-percent {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-units {
      background: #fef3c7;
      color: #92400e;
    }

    .summary-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      padding: 2rem;
      margin-top: 2rem;
      border: 2px solid #dee2e6;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .summary-card {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #667eea;
    }

    .summary-card h3 {
      margin: 0 0 0.5rem 0;
      color: #64748b;
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-card p {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #64748b;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.5rem;
      color: #2d3748;
    }

    .empty-state p {
      margin: 0;
      font-size: 1rem;
    }

    .footer {
      background: #f8f9fa;
      padding: 1.5rem;
      text-align: center;
      color: #64748b;
      font-size: 0.875rem;
      border-top: 2px solid #e9ecef;
    }

    .footer .criado-por {
      margin-top: 0.5rem;
      font-weight: 600;
      color: #667eea;
      font-size: 0.95rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .limit-warning {
      background: #fef3c7;
      border: 2px solid #fbbf24;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #92400e;
      font-weight: 600;
      text-align: center;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <header class="header">
    <div class="logo-container" id="logo-container" style="display: none;"><img id="logo-img" src="" alt="Logo" onerror="this.style.display='none'; this.parentElement.style.display='none';">
    </div>
    <h1 id="titulo-principal">Calculadora de Rendimento Aliment√≠cio</h1>
    <p id="subtitulo">An√°lise profissional de custos e rendimento de produtos</p>
   </header>
   <main class="content">
    <section class="form-section">
     <div id="limit-warning-container"></div>
     <div class="calculation-mode"><button class="mode-btn active" id="mode-percent" onclick="setCalculationMode('percent')"> üìä C√°lculo por Rendimento (%) </button> <button class="mode-btn" id="mode-units" onclick="setCalculationMode('units')"> üî¢ C√°lculo por Unidades </button>
     </div>
     <div class="form-grid">
      <div class="form-group"><label for="produto">Produto</label> <input type="text" id="produto" placeholder="Ex: Carne Bovina">
      </div>
      <div class="form-group"><label for="quantidade">Quantidade (kg)</label> <input type="number" id="quantidade" step="0.01" min="0" placeholder="0.00">
      </div>
      <div class="form-group"><label for="preco">Pre√ßo por kg (R$)</label> <input type="number" id="preco" step="0.01" min="0" placeholder="0.00">
      </div>
      <div class="form-group" id="rendimento-group"><label for="rendimento"> Rendimento (%) <span class="info-badge">OPCIONAL</span> </label> <input type="number" id="rendimento" step="0.1" min="0" max="100" placeholder="0.0">
      </div>
      <div class="form-group" id="unidades-group" style="display: none;"><label for="unidades">Unidades Produzidas</label> <input type="number" id="unidades" step="1" min="0" placeholder="0">
      </div>
     </div><button class="btn btn-primary" id="btn-adicionar"> <span id="btn-adicionar-text">‚ûï Adicionar Produto</span> </button>
    </section>
    <div class="export-section"><button class="btn btn-readme" id="btn-readme"> üìÑ Baixar README </button>
     <div id="export-buttons" style="display: none;"><button class="btn btn-export" id="btn-export"> üì• Exportar para Excel </button>
     </div>
    </div>
    <div class="table-container" id="table-container">
     <div class="empty-state">
      <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
      <h3>Nenhum produto adicionado</h3>
      <p>Preencha o formul√°rio acima para come√ßar</p>
     </div>
    </div>
    <div class="summary-section" id="summary-section" style="display: none;">
     <div class="summary-grid">
      <div class="summary-card">
       <h3>Total de Produtos</h3>
       <p id="total-produtos">0</p>
      </div>
      <div class="summary-card">
       <h3>Custo Total Bruto</h3>
       <p id="custo-total-bruto">R$ 0,00</p>
      </div>
      <div class="summary-card">
       <h3>Custo Total L√≠quido</h3>
       <p id="custo-total-liquido">R$ 0,00</p>
      </div>
      <div class="summary-card">
       <h3>Perda Total</h3>
       <p id="perda-total">R$ 0,00</p>
      </div>
     </div>
    </div>
   </main>
   <footer class="footer">
    <div class="criado-por" id="criado-por">
     Criado por Guilherme Pereira
    </div>
   </footer>
  </div>
  <script>
    const defaultConfig = {
      logo_url: "",
      titulo_principal: "Calculadora de Rendimento Aliment√≠cio",
      subtitulo: "An√°lise profissional de custos e rendimento de produtos",
      botao_adicionar: "‚ûï Adicionar Produto",
      criado_por: "Copyright (c) 2025 Guilherme Pereira",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#2d3748",
      primary_action_color: "#667eea",
      secondary_action_color: "#ef4444",
      font_family: "Inter",
      font_size: 16
    };

    let currentData = [];
    let isLoading = false;
    let calculationMode = 'percent';

    const dataHandler = {
      onDataChanged(data) {
        currentData = data;
        renderTable(data);
        updateSummary(data);
      }
    };

    async function initializeApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Erro ao inicializar SDK");
      }
    }

    function setCalculationMode(mode) {
      calculationMode = mode;
      
      document.getElementById('mode-percent').classList.toggle('active', mode === 'percent');
      document.getElementById('mode-units').classList.toggle('active', mode === 'units');
      
      if (mode === 'percent') {
        document.getElementById('rendimento-group').style.display = 'flex';
        document.getElementById('unidades-group').style.display = 'none';
        document.getElementById('unidades').value = '';
      } else {
        document.getElementById('rendimento-group').style.display = 'none';
        document.getElementById('unidades-group').style.display = 'flex';
        document.getElementById('rendimento').value = '';
      }
    }

    function renderTable(data) {
      const container = document.getElementById('table-container');
      const exportButtons = document.getElementById('export-buttons');
      
      if (data.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <h3>Nenhum produto adicionado</h3>
            <p>Preencha o formul√°rio acima para come√ßar</p>
          </div>
        `;
        document.getElementById('summary-section').style.display = 'none';
        exportButtons.style.display = 'none';
        return;
      }

      document.getElementById('summary-section').style.display = 'block';
      exportButtons.style.display = 'block';

      const sortedData = [...data].sort((a, b) => 
        new Date(b.created_at) - new Date(a.created_at)
      );

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Produto</th>
              <th>Tipo</th>
              <th>Quantidade (kg)</th>
              <th>Pre√ßo/kg</th>
              <th>Rendimento/Unidades</th>
              <th>Custo Total</th>
              <th>Custo L√≠quido</th>
              <th>Custo/Unidade</th>
              <th>Perda</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${sortedData.map(item => {
              const perda = item.custo_total - item.custo_liquido;
              const tipoBadge = item.tipo_calculo === 'percent' 
                ? '<span class="badge badge-percent">% Rendimento</span>'
                : '<span class="badge badge-units">üî¢ Unidades</span>';
              
              const rendimentoDisplay = item.tipo_calculo === 'percent'
                ? `${item.rendimento_percent.toFixed(1)}%`
                : `${item.unidades_produzidas} un.`;
              
              const custoUnidade = item.custo_por_unidade > 0
                ? `R$ ${item.custo_por_unidade.toFixed(2)}`
                : '-';

              return `
              <tr data-id="${item.id}">
                <td><strong>${item.produto}</strong></td>
                <td>${tipoBadge}</td>
                <td>${item.quantidade_kg.toFixed(2)} kg</td>
                <td>R$ ${item.preco_kg.toFixed(2)}</td>
                <td>${rendimentoDisplay}</td>
                <td>R$ ${item.custo_total.toFixed(2)}</td>
                <td>R$ ${item.custo_liquido.toFixed(2)}</td>
                <td>${custoUnidade}</td>
                <td>R$ ${perda.toFixed(2)}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteProduct('${item.__backendId}')">
                    üóëÔ∏è Excluir
                  </button>
                </td>
              </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    function updateSummary(data) {
      const totalProdutos = data.length;
      const custoTotalBruto = data.reduce((sum, item) => sum + item.custo_total, 0);
      const custoTotalLiquido = data.reduce((sum, item) => sum + item.custo_liquido, 0);
      const perdaTotal = custoTotalBruto - custoTotalLiquido;

      document.getElementById('total-produtos').textContent = totalProdutos;
      document.getElementById('custo-total-bruto').textContent = `R$ ${custoTotalBruto.toFixed(2)}`;
      document.getElementById('custo-total-liquido').textContent = `R$ ${custoTotalLiquido.toFixed(2)}`;
      document.getElementById('perda-total').textContent = `R$ ${perdaTotal.toFixed(2)}`;
    }

    async function addProduct() {
      if (isLoading) return;

      if (currentData.length >= 999) {
        document.getElementById('limit-warning-container').innerHTML = `
          <div class="limit-warning">
            ‚ö†Ô∏è Limite m√°ximo de 999 produtos atingido. Exclua alguns produtos para adicionar novos.
          </div>
        `;
        return;
      }

      const produto = document.getElementById('produto').value.trim();
      const quantidade = parseFloat(document.getElementById('quantidade').value);
      const preco = parseFloat(document.getElementById('preco').value);

      if (!produto || isNaN(quantidade) || isNaN(preco)) {
        return;
      }

      if (quantidade <= 0 || preco <= 0) {
        return;
      }

      let rendimento = 0;
      let unidades = 0;
      let custoTotal = quantidade * preco;
      let custoLiquido = 0;
      let custoPorUnidade = 0;

      if (calculationMode === 'percent') {
        rendimento = parseFloat(document.getElementById('rendimento').value) || 0;
        
        if (rendimento < 0 || rendimento > 100) {
          return;
        }

        if (rendimento > 0) {
          custoLiquido = custoTotal * (rendimento / 100);
        } else {
          custoLiquido = custoTotal;
        }
      } else {
        unidades = parseInt(document.getElementById('unidades').value) || 0;
        
        if (unidades <= 0) {
          return;
        }

        custoLiquido = custoTotal;
        custoPorUnidade = custoTotal / unidades;
      }

      isLoading = true;
      const btn = document.getElementById('btn-adicionar');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Adicionando...';

      const newProduct = {
        id: Date.now().toString(),
        produto: produto,
        quantidade_kg: quantidade,
        preco_kg: preco,
        rendimento_percent: rendimento,
        unidades_produzidas: unidades,
        tipo_calculo: calculationMode,
        custo_total: custoTotal,
        custo_liquido: custoLiquido,
        custo_por_unidade: custoPorUnidade,
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(newProduct);

      if (result.isOk) {
        document.getElementById('produto').value = '';
        document.getElementById('quantidade').value = '';
        document.getElementById('preco').value = '';
        document.getElementById('rendimento').value = '';
        document.getElementById('unidades').value = '';
        document.getElementById('limit-warning-container').innerHTML = '';
      }

      isLoading = false;
      btn.disabled = false;
      btn.innerHTML = `<span id="btn-adicionar-text">${window.elementSdk?.config?.botao_adicionar || defaultConfig.botao_adicionar}</span>`;
    }

    async function deleteProduct(backendId) {
      if (isLoading) return;

      const product = currentData.find(item => item.__backendId === backendId);
      if (!product) return;

      isLoading = true;

      const result = await window.dataSdk.delete(product);

      isLoading = false;
    }

    function exportToExcel() {
      if (currentData.length === 0) return;

      const sortedData = [...currentData].sort((a, b) => 
        new Date(b.created_at) - new Date(a.created_at)
      );

      const custoTotalBruto = sortedData.reduce((sum, item) => sum + item.custo_total, 0);
      const custoTotalLiquido = sortedData.reduce((sum, item) => sum + item.custo_liquido, 0);
      const perdaTotal = custoTotalBruto - custoTotalLiquido;

      let excelContent = `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Styles>
  <Style ss:ID="header">
   <Font ss:Bold="1" ss:Color="#FFFFFF"/>
   <Interior ss:Color="#667eea" ss:Pattern="Solid"/>
   <Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
  </Style>
  <Style ss:ID="total">
   <Font ss:Bold="1"/>
   <Interior ss:Color="#f8f9fa" ss:Pattern="Solid"/>
  </Style>
  <Style ss:ID="currency">
   <NumberFormat ss:Format="&quot;R$ &quot;#,##0.00"/>
  </Style>
 </Styles>
 <Worksheet ss:Name="Produtos">
  <Table>
   <Column ss:Width="150"/>
   <Column ss:Width="100"/>
   <Column ss:Width="100"/>
   <Column ss:Width="100"/>
   <Column ss:Width="120"/>
   <Column ss:Width="100"/>
   <Column ss:Width="100"/>
   <Column ss:Width="100"/>
   <Column ss:Width="100"/>
   <Row ss:StyleID="header">
    <Cell><Data ss:Type="String">Produto</Data></Cell>
    <Cell><Data ss:Type="String">Tipo</Data></Cell>
    <Cell><Data ss:Type="String">Quantidade (kg)</Data></Cell>
    <Cell><Data ss:Type="String">Pre√ßo/kg</Data></Cell>
    <Cell><Data ss:Type="String">Rendimento/Unidades</Data></Cell>
    <Cell><Data ss:Type="String">Custo Total</Data></Cell>
    <Cell><Data ss:Type="String">Custo L√≠quido</Data></Cell>
    <Cell><Data ss:Type="String">Custo/Unidade</Data></Cell>
    <Cell><Data ss:Type="String">Perda</Data></Cell>
   </Row>`;

      sortedData.forEach(item => {
        const perda = item.custo_total - item.custo_liquido;
        const tipo = item.tipo_calculo === 'percent' ? 'Rendimento %' : 'Unidades';
        const rendimentoDisplay = item.tipo_calculo === 'percent'
          ? item.rendimento_percent.toFixed(1) + '%'
          : item.unidades_produzidas + ' un.';
        const custoUnidade = item.custo_por_unidade > 0 ? item.custo_por_unidade.toFixed(2) : '0.00';

        excelContent += `
   <Row>
    <Cell><Data ss:Type="String">${item.produto}</Data></Cell>
    <Cell><Data ss:Type="String">${tipo}</Data></Cell>
    <Cell><Data ss:Type="Number">${item.quantidade_kg.toFixed(2)}</Data></Cell>
    <Cell ss:StyleID="currency"><Data ss:Type="Number">${item.preco_kg.toFixed(2)}</Data></Cell>
    <Cell><Data ss:Type="String">${rendimentoDisplay}</Data></Cell>
    <Cell ss:StyleID="currency"><Data ss:Type="Number">${item.custo_total.toFixed(2)}</Data></Cell>
    <Cell ss:StyleID="currency"><Data ss:Type="Number">${item.custo_liquido.toFixed(2)}</Data></Cell>
    <Cell ss:StyleID="currency"><Data ss:Type="Number">${custoUnidade}</Data></Cell>
    <Cell ss:StyleID="currency"><Data ss:Type="Number">${perda.toFixed(2)}</Data></Cell>
   </Row>`;
      });

      excelContent += `
   <Row></Row>
   <Row ss:StyleID="total">
    <Cell><Data ss:Type="String">TOTAIS</Data></Cell>
    <Cell><Data ss:Type="String">Total de Produtos: ${sortedData.length}</Data></Cell>
    <Cell></Cell>
    <Cell></Cell>
    <Cell></Cell>
    <Cell ss:StyleID="currency"><Data ss:Type="Number">${custoTotalBruto.toFixed(2)}</Data></Cell>
    <Cell ss:StyleID="currency"><Data ss:Type="Number">${custoTotalLiquido.toFixed(2)}</Data></Cell>
    <Cell></Cell>
    <Cell ss:StyleID="currency"><Data ss:Type="Number">${perdaTotal.toFixed(2)}</Data></Cell>
   </Row>
  </Table>
 </Worksheet>
</Workbook>`;

      const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      
      const hoje = new Date();
      const dataFormatada = `${hoje.getDate().toString().padStart(2, '0')}-${(hoje.getMonth() + 1).toString().padStart(2, '0')}-${hoje.getFullYear()}`;
      link.download = `Produtos_${dataFormatada}.xls`;
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    }

    function downloadReadme() {
      const readmeContent = `# üìä Calculadora de Rendimento Aliment√≠cio

![Vers√£o](https://img.shields.io/badge/vers√£o-3.0.0-blue.svg)
![Licen√ßa](https://img.shields.io/badge/licen√ßa-MIT-green.svg)
![Status](https://img.shields.io/badge/status-ativo-success.svg)

## üìù Descri√ß√£o

Calculadora profissional de rendimento de produtos aliment√≠cios desenvolvida para auxiliar na gest√£o de custos e an√°lise de perdas em estabelecimentos gastron√¥micos, cozinhas industriais e gestores de alimentos.

A aplica√ß√£o permite calcular automaticamente o custo real dos produtos considerando o percentual de rendimento ap√≥s o processamento OU o n√∫mero de unidades produzidas, fornecendo dados precisos sobre custos brutos, l√≠quidos, perdas financeiras e custo por unidade.

## ‚ú® Funcionalidades

### Vers√£o 3.0.0 (Atual) - NOVO! üéâ
- ‚úÖ **Dois Modos de C√°lculo**:
  - üìä **Por Rendimento (%)**: Calcula baseado no percentual de aproveitamento
  - üî¢ **Por Unidades**: Calcula baseado na quantidade de produtos finais
- ‚úÖ **Custo por Unidade**: C√°lculo autom√°tico do custo individual de cada produto
- ‚úÖ **Rendimento Opcional**: N√£o √© mais obrigat√≥rio preencher o rendimento
- ‚úÖ **Badges Visuais**: Identifica√ß√£o clara do tipo de c√°lculo usado
- ‚úÖ **Exporta√ß√£o Completa**: Excel inclui todos os novos campos

### Vers√£o 2.0.0
- ‚úÖ Exporta√ß√£o para Excel com formata√ß√£o profissional
- ‚úÖ Download de README
- ‚úÖ Campo para logo personaliz√°vel
- ‚úÖ Cr√©ditos do criador

### Vers√£o 1.0.0
- ‚úÖ Cadastro b√°sico de produtos
- ‚úÖ C√°lculos de rendimento
- ‚úÖ Tabela de visualiza√ß√£o
- ‚úÖ Resumo de totais

## üöÄ Como Usar

### 1. Escolher Modo de C√°lculo
Escolha entre dois modos:
- **üìä C√°lculo por Rendimento (%)**: Para produtos com perda de peso/volume
- **üî¢ C√°lculo por Unidades**: Para produtos que geram unidades cont√°veis

### 2. Adicionar Produtos

#### Modo Rendimento (%):
1. Preencha o nome do produto (ex: "Carne Bovina")
2. Informe a quantidade em kg (ex: 5.00)
3. Digite o pre√ßo por kg em R$ (ex: 35.00)
4. Insira o percentual de rendimento (ex: 75%) - OPCIONAL
5. Clique em "‚ûï Adicionar Produto"

**Exemplo**: 5kg de carne a R$ 35/kg com 75% de rendimento
- Custo Total: R$ 175,00
- Custo L√≠quido: R$ 131,25 (75% de R$ 175)
- Perda: R$ 43,75

#### Modo Unidades:
1. Preencha o nome do produto (ex: "Bolo de Chocolate")
2. Informe a quantidade em kg (ex: 2.50)
3. Digite o pre√ßo por kg em R$ (ex: 15.00)
4. Insira quantas unidades foram produzidas (ex: 12)
5. Clique em "‚ûï Adicionar Produto"

**Exemplo**: 2.5kg de ingredientes a R$ 15/kg gerando 12 bolos
- Custo Total: R$ 37,50
- Custo L√≠quido: R$ 37,50
- Custo por Unidade: R$ 3,13
- Perda: R$ 0,00

### 3. Visualizar Dados
- A tabela mostra todos os produtos com badges identificando o tipo
- O resumo exibe totais consolidados
- Coluna "Custo/Unidade" mostra o valor individual (quando aplic√°vel)

### 4. Exportar para Excel
1. Clique no bot√£o "üì• Exportar para Excel"
2. O arquivo inclui todos os campos: tipo, rendimento/unidades, custo por unidade
3. Nome do arquivo: \`Produtos_DD-MM-AAAA.xls\`

## üìä Exemplos de Uso

### Exemplo 1: Carne (Rendimento %)
- **Produto**: Picanha
- **Quantidade**: 10 kg
- **Pre√ßo/kg**: R$ 45,00
- **Rendimento**: 80%
- **Resultado**:
  - Custo Total: R$ 450,00
  - Custo L√≠quido: R$ 360,00
  - Perda: R$ 90,00

### Exemplo 2: Bolos (Unidades)
- **Produto**: Bolo de Cenoura
- **Quantidade**: 3 kg
- **Pre√ßo/kg**: R$ 12,00
- **Unidades**: 8 bolos
- **Resultado**:
  - Custo Total: R$ 36,00
  - Custo L√≠quido: R$ 36,00
  - Custo por Unidade: R$ 4,50
  - Perda: R$ 0,00

### Exemplo 3: Sem Rendimento
- **Produto**: Arroz
- **Quantidade**: 5 kg
- **Pre√ßo/kg**: R$ 8,00
- **Rendimento**: (deixar vazio)
- **Resultado**:
  - Custo Total: R$ 40,00
  - Custo L√≠quido: R$ 40,00
  - Perda: R$ 0,00

## üõ†Ô∏è Tecnologias Utilizadas

- **HTML5**: Estrutura sem√¢ntica
- **CSS3**: Estiliza√ß√£o com Tailwind CSS e gradientes
- **JavaScript (ES6+)**: L√≥gica de neg√≥cio e manipula√ß√£o de dados
- **Canva Data SDK**: Persist√™ncia de dados em Planilha Canva
- **Canva Element SDK**: Personaliza√ß√£o via interface Canva
- **XML/Excel**: Exporta√ß√£o de dados em formato Excel

## üì¶ Estrutura de Dados

\`\`\`javascript
{
  id: "string",                    // ID √∫nico do produto
  produto: "string",                // Nome do produto
  quantidade_kg: number,            // Quantidade em kg
  preco_kg: number,                 // Pre√ßo por kg em R$
  rendimento_percent: number,       // Percentual de rendimento (0-100)
  unidades_produzidas: number,      // Quantidade de unidades produzidas
  tipo_calculo: "string",           // "percent" ou "units"
  custo_total: number,              // Custo total bruto calculado
  custo_liquido: number,            // Custo l√≠quido calculado
  custo_por_unidade: number,        // Custo individual por unidade
  created_at: "string"              // Data/hora de cria√ß√£o (ISO)
}
\`\`\`

## üîí Limita√ß√µes

- **M√°ximo de 999 produtos**: Limite t√©cnico da plataforma
- **Dados locais**: Os dados s√£o salvos na sua conta Canva
- **Navegador moderno**: Requer navegador com suporte a ES6+

## üìã Changelog

### [3.0.0] - 2024-01-15
#### Adicionado
- Dois modos de c√°lculo: Rendimento (%) e Unidades
- Campo "Unidades Produzidas" para c√°lculo por quantidade
- Coluna "Custo por Unidade" na tabela
- Badges visuais para identificar tipo de c√°lculo
- Rendimento agora √© opcional
- Exporta√ß√£o Excel com novos campos

#### Melhorado
- Interface com sele√ß√£o de modo de c√°lculo
- Flexibilidade para diferentes tipos de produtos
- C√°lculos mais precisos para produ√ß√£o em unidades

### [2.0.0] - 2024-01-15
#### Adicionado
- Exporta√ß√£o para Excel
- Bot√£o de download do README
- Logo personaliz√°vel
- Cr√©ditos do criador

### [1.0.0] - 2024-01-14
#### Adicionado
- Vers√£o inicial da calculadora

## üìÑ Licen√ßa

MIT License

Copyright (c) 2025 Guilherme Pereira

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

## üë§ Autor

**Guilherme Pereira**

- Criador e desenvolvedor principal
- Especialista em gest√£o de custos aliment√≠cios

## ü§ù Contribuindo

Contribui√ß√µes, issues e solicita√ß√µes de recursos s√£o bem-vindas!

---

**Desenvolvido com ‚ù§Ô∏è por Guilherme Pereira**`;

      const blob = new Blob([readmeContent], { type: 'text/markdown;charset=utf-8' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'README.md';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    }

    document.getElementById('btn-adicionar').addEventListener('click', addProduct);
    document.getElementById('btn-export').addEventListener('click', exportToExcel);
    document.getElementById('btn-readme').addEventListener('click', downloadReadme);

    document.getElementById('produto').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addProduct();
    });
    document.getElementById('quantidade').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addProduct();
    });
    document.getElementById('preco').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addProduct();
    });
    document.getElementById('rendimento').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addProduct();
    });
    document.getElementById('unidades').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addProduct();
    });

    async function onConfigChange(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;

      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.body.style.fontSize = `${baseSize}px`;

      const backgroundColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryActionColor = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryActionColor = config.secondary_action_color || defaultConfig.secondary_action_color;

      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${primaryActionColor} 100%)`;
      document.querySelector('.container').style.background = surfaceColor;
      document.querySelector('.header').style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${primaryActionColor} 100%)`;
      document.querySelector('.btn-primary').style.background = `linear-gradient(135deg, ${backgroundColor} 0%, ${primaryActionColor} 100%)`;
      
      const deleteButtons = document.querySelectorAll('.btn-delete');
      deleteButtons.forEach(btn => {
        btn.style.background = secondaryActionColor;
      });

      const allText = document.querySelectorAll('td, label, .empty-state h3, .empty-state p, .summary-card h3');
      allText.forEach(el => {
        el.style.color = textColor;
      });

      const logoUrl = config.logo_url || defaultConfig.logo_url;
      const logoContainer = document.getElementById('logo-container');
      const logoImg = document.getElementById('logo-img');
      
      if (logoUrl && logoUrl.trim() !== '') {
        logoImg.src = logoUrl;
        logoContainer.style.display = 'flex';
      } else {
        logoContainer.style.display = 'none';
      }

      document.getElementById('titulo-principal').textContent = config.titulo_principal || defaultConfig.titulo_principal;
      document.getElementById('subtitulo').textContent = config.subtitulo || defaultConfig.subtitulo;
      
      const btnText = document.getElementById('btn-adicionar-text');
      if (btnText) {
        btnText.textContent = config.botao_adicionar || defaultConfig.botao_adicionar;
      }
      
      document.getElementById('criado-por').textContent = config.criado_por || defaultConfig.criado_por;

      document.querySelector('.header h1').style.fontSize = `${baseSize * 2.5}px`;
      document.querySelector('.header p').style.fontSize = `${baseSize * 1.1}px`;
      document.querySelectorAll('th').forEach(el => el.style.fontSize = `${baseSize * 0.95}px`);
      document.querySelectorAll('td').forEach(el => el.style.fontSize = `${baseSize * 0.95}px`);
      document.querySelectorAll('.summary-card h3').forEach(el => el.style.fontSize = `${baseSize * 0.875}px`);
      document.querySelectorAll('.summary-card p').forEach(el => el.style.fontSize = `${baseSize * 2}px`);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.primary_action_color || defaultConfig.primary_action_color,
              set: (value) => {
                config.primary_action_color = value;
                window.elementSdk.setConfig({ primary_action_color: value });
              }
            },
            {
              get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
              set: (value) => {
                config.secondary_action_color = value;
                window.elementSdk.setConfig({ secondary_action_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["logo_url", config.logo_url || defaultConfig.logo_url],
          ["titulo_principal", config.titulo_principal || defaultConfig.titulo_principal],
          ["subtitulo", config.subtitulo || defaultConfig.subtitulo],
          ["botao_adicionar", config.botao_adicionar || defaultConfig.botao_adicionar],
          ["criado_por", config.criado_por || defaultConfig.criado_por]
        ])
      });
    }

    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a0317253027f61a',t:'MTc2MzQyMzAwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>